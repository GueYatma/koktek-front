name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Récupération du code
        uses: actions/checkout@v2

      - name: 2. Préparer les infos de build
        run: |
          echo "VITE_BUILD_ID=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "VITE_BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          printf "VITE_BUILD_MESSAGE<<EOF\n%s\nEOF\n" "$(git log -1 --pretty=%s)" >> $GITHUB_ENV

      - name: 3. Construction sur GitHub (Build)
        # On prépare le site ici, sur les serveurs de GitHub
        run: |
          npm install
          npm run build

      - name: 4. Préparer un dossier de déploiement temporaire
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            NEW_DIR="/root/koktek_front/dist_tmp_${{ github.sha }}"
            rm -rf "${NEW_DIR}"
            mkdir -p "${NEW_DIR}"
            echo "Dossier temporaire prêt: ${NEW_DIR}"

      - name: 5. Envoi du nouveau site (SCP -> dossier temporaire)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "dist/*"
          target: "/root/koktek_front/dist_tmp_${{ github.sha }}/"
          strip_components: 1
          # strip_components: 1 permet de copier le CONTENU du dossier dist directement à la racine de la cible

      - name: 6. Bascule atomique vers le nouveau site
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            NEW_DIR="/root/koktek_front/dist_tmp_${{ github.sha }}"
            LIVE_DIR="/root/koktek_front/dist"
            BACKUP_DIR="/root/koktek_front/dist_prev"

            if [ ! -d "${NEW_DIR}" ]; then
              echo "Dossier temporaire introuvable: ${NEW_DIR}"
              exit 1
            fi

            rm -rf "${BACKUP_DIR}"
            if [ -d "${LIVE_DIR}" ]; then
              mv "${LIVE_DIR}" "${BACKUP_DIR}"
            fi

            mv "${NEW_DIR}" "${LIVE_DIR}"
            rm -rf "${BACKUP_DIR}"
            echo "Bascule terminée."
